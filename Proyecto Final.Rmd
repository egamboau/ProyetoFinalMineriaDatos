---
title: 'Tarea de R #5'
author: "Eduardo Gamboa Ureña"
date: "22 de octubre de 2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Análisis del Problema
Para una compañía aseguradora, es importante tener muchos clientes, seguros que, aún cuando es poco probable que sean utilizados por sus clientes, generen ganancias para ellos y para, en general, los accionistas de la empresa. A fin de lograr esto, es necesario atacar, con la publicidad correcta, al mercado correcto, a fin de que estos futuros clientes puedean obtener, de manera rápida, los productos ofrecidos. 
A fin de poder conocer el mercado de los seguro para caravanas, un vehiculo que esta equipado para vivir en él, se realizaron muestras de diversoas variables del contexto de futuros clientes, a fin de poder conocer si, dado un cierto grupo de características, la persona compraría un seguro o no. 

## Entendimiento de los Datos

A continuación un diccionario de datos, los cuales serán los analizados en este trabajo:

1. MOSTYPE Tipo de cliente. Categorica. Los posibles valores son:
    1. Ingreso alto, con niños caros
    2. provinciano muy importante
    3. Ancianos de alto estado social
    4. Ancianos aluentes con apartamentos
    5. Ancianos mezclados
    6. Cuidadodes, ya sea de adultos o de niños
    7. Doble ingreso, sin niños
    8. familias calse media
    9. familias modernas completas
    10. Familias estables
    11. FAmilias iniciando
    12. familias jóvenes afluentes
    13. familia joven, todos estadounidenses
    14. Cosmopolita joven
    15. Cosmopolita anciano
    16. Estudiantes en apartamentos
    17. Recien graduados en la ciudad
    18. Joben soltero
    19. Joven suburbano
    20. etnicamente diverso
    21. joven urbano sin beneficios materiales
    22. varias personas que viven en apartamentos
    23. Jovenes y creciendo
    24. Jovenes, baja educacion
    25. Ancianos jovenes en la ciudad
    26. Ancianos dueños de casa
    27. Ancianos en apartamentos
    28. Ancianos residenciales
    29. Ancianos sin patio delantero
    30. Ancianos solteros religiosos
    31. Católicos con bajo ingreso
    32. Ancianos mezclados
    33. Familias largas de baja clase
    34. Familias largas, con hijos empleados
    35. Familias de villas
    36. Familia con adolescentes
    37. Habitates mezclados de pueblos pequeños
    38. Familia tradicional
    39. Familias religiosas largas
    40  Largas Familia de granjas
    41. Rurales mezcladas

2. MAANTHUI Numero de casas, de 1 a 10
3. MGEMOMV tamaño promedio de casa, de 1 a 6
4. MGEMLEEF Edad promedio.
    1. 20-30 años
    2. 30-40 años
    3. 40-50 años
    4. 50-60 años
    5. 60-70 años
    6. 70-80 años
5. MOSHOOFD Categórica. Tipo de cliente principal.
    1. Hedonista exitoso
    2. Granjero conducido
    3. Familia Promedio
    4. Deudor de prestamos para carreras
    5. Viviendo bien
    6. Ancianos viajeros
    7. retirados y religiosos
    8. Familia con personas adultas
    9. Familias conservativas
    10. Granjeros
6. MGODRK Católicos romanos
7. MGODPR Protestantes
8. MGODOV Otra religion
9. MGODGE Sin Religion
10. MRELGE Casado
11. MRELSA Viviendo Juntos
12. MRELOV Otra relacion
13. MFALLEEN Solteros
14. MFGEKIND ocupantes de casa sin niños
15. MFWEKIND ocupantes de casa sin niños
16. MOPLHOOG educacion de alto nivel
17. MOPLMIDD educacion media
18. MOPLLAAG educacion baja
19. MBERHOOG alto estatus
20. MBERZELF Emprendedor
21. MBERBOER Granjero
22. MBERMIDD Administrador medio
23. MBERARBG Trabajador con habilidades
24. MBERARBO Trabajador sin habilidades
25. MSKA Clase socuial A
26. MSKB1 Clase social B1
27. MSKB2 Clase social B2
28. MSKC Clase social C
29. MSKD Clase social D
30. MHHUUR casa rentada
31. MHKOOP Dueños de casa
32. MAUT1 1 auto
33. MAUT2 2 autos
34. MAUT0 Sin autos
35. MZFONDS Servicio nacional de salud
36. MZPART Seguro de salud privado
37. MINKM30 Ingreso menor de  30.000
38. MINK3045 Ingreso entre 30-45.000
39. MINK4575 Ingreso entre 45-75.000
40. MINK7512 Ingreso entre 75-122.000
41. MINK123M Ingreso mayor que 123.000
42. MINKGEM Ingreso promedio
43. MKOOPKLA Clase de poder de compra
44. PWAPART Contribucion de seguros de terceros
45. PWABEDR Contribucion de seguros de terceros
46. PWALAND Contribucion de seguros de terceros en agricultura
47. PPERSAUT Contribucion en contratos de seguros de automoviles
48. PBESAUT Contribudion en contratos de seguros en camionetas de entrega
49. PMOTSCO Contribudion en contratos de seguros  motocicletas
50. PVRAAUT Contribudion en contratos de seguros  de camiones
51. PAANHANG Contribudion en contratos de seguros de trailers
52. PTRACTOR Contribudion en contratos de seguros  de tractores
53. PWERKT Contribudion en contratos de seguros  de maquinas de agrcultura
54. PBROM PContribudion en contratos de seguros  motocicletas pequeñas
55. PLEVEN Contribucion de seguros de vida
56. PPERSONG Contribudion en contratos de seguros  de accidentes privados
57. PGEZONG Contribudion en contratos de seguros  de accidentes de famiia
58. PWAOREG Contrato de seguros de contribucion de invalidez
59. PBRAND Contrato de seguros de contribucion de seguros contra incendios
60. PZEILPL Contrato de seguros de contribucion en seguros de tablas de surfContribution surfboard policies
61. PPLEZIER Contrato de seguros de contribucion en seguros de botes
62. PFIETS Contrato de seguros de contribucion en seguros de bicicletas
63. PINBOED Contrato de seguros de contribucion de seguros de propiedades
64. PBYSTAND Contrato de seguros de contribucion de seguro social
65. AWAPART Numero de seguros de terceros 
66. AWABEDR Numero de firmas de seguros de terceras personas
67. AWALAND Numero de seguros de terceras personas
68. APERSAUT Numero de contratos de seguros de automoviles
69. ABESAUT Numero de contratos de seguros de camionetas de entrega
70. AMOTSCO Numero de contratos de seguros de motocicletas o scooter
71. AVRAAUT Numero de contratos de seguros de camiones
72. AAANHANG Numero de contratos de seguros de trailer
73. ATRACTOR Numero de contratos de seguros tractor
74. AWERKT Numero de contratos de seguros de maquinaria de agricultura
75. ABROM Numero de contratos de seguros en moticicletas pequeñas
76. ALEVEN numero de seguros de vida
77. APERSONG numero de contratos de seguros de accidente privado
78. AGEZONG numero de contratos de seguros de accidentes familiares
79. AWAOREG numero de contratos de seguros de invalidez familiares
80. ABRAND numero de contratos de seguros de incendios
81. AZEILPL numero de contratos de seguros de tablas de surf
82. APLEZIER numero de contratos de seguros de botes
83. AFIETS numero de contratos de seguros de bicicletas
84. AINBOED numero de contratos de seguros de propiedades
85. ABYSTAND numero de contratos de seguros de seguro social
86. CARAVAN numero de contratos de casas moviles. 0 o 1.

Ademas, como notas aclaratorias:

1. Las variables que inician con M son variables de area, no especificas del cliente. Se basan en el codigo ZIP donde el cliente esta ubicado, y reflejan la distribucion de la variable en cuestion
1. Las siguientes columnas comparte su dominio, los valores que solo pertencen a una sola columa estan especificados en la lista anterior:
    1. Columnas de la 7 a la 43, todas estas se comportan como porcentajes. Los valores se especifican a continuacion:
        0. 0%
        1. 1 - 10%
        2. 11 - 23%
        3. 24 - 36%
        4. 37 - 49%
        5 50 - 62%
        6. 63 - 75%
        7. 76 - 88%
        8. 89 - 99%
        9. 100%
    1. Las columnas de la 44 a la 64, todas son valores monetarios. Sus posibles valores son:
        0. 0
        1. 1 a 49
        2. 50 a 99
        3. 100 a 199
        4. 200 a 499
        5. 500 a 999
        6. 1000 a 4999
        7. 5000 a 9999
        8. 10.000 a 19.999
        9. 20.000 o mayor
    1. Las columnas de la 45  a la 85, son numericas, con rango de 1 a 12

## Exploración de los Datos

Se procede a cargar los datos, a fin de poder procesarlos en la herramienta. Se brinda tambien una resumen de la estructura de los mismos
```{r carga de datos}
columnas = c('MOSTYPE', 'MAANTHUI', 'MGEMOMV', 'MGEMLEEF', 'MOSHOOFD', 'MGODRK', 'MGODPR', 'MGODOV', 'MGODGE', 'MRELGE', 'MRELSA', 'MRELOV', 'MFALLEEN', 'MFGEKIND', 'MFWEKIND', 'MOPLHOOG', 'MOPLMIDD', 'MOPLLAAG', 'MBERHOOG', 'MBERZELF', 'MBERBOER', 'MBERMIDD', 'MBERARBG', 'MBERARBO', 'MSKA', 'MSKB1', 'MSKB2', 'MSKC', 'MSKD', 'MHHUUR', 'MHKOOP', 'MAUT1', 'MAUT2', 'MAUT0', 'MZFONDS', 'MZPART', 'MINKM30', 'MINK3045', 'MINK4575', 'MINK7512', 'MINK123M', 'MINKGEM', 'MKOOPKLA', 'PWAPART', 'PWABEDR', 'PWALAND', 'PPERSAUT', 'PBESAUT', 'PMOTSCO', 'PVRAAUT', 'PAANHANG', 'PTRACTOR', 'PWERKT', 'PBROM', 'PLEVEN', 'PPERSONG', 'PGEZONG', 'PWAOREG', 'PBRAND', 'PZEILPL', 'PPLEZIER', 'PFIETS', 'PINBOED', 'PBYSTAND', 'AWAPART', 'AWABEDR', 'AWALAND', 'APERSAUT', 'ABESAUT', 'AMOTSCO', 'AVRAAUT', 'AAANHANG', 'ATRACTOR', 'AWERKT', 'ABROM', 'ALEVEN', 'APERSONG', 'AGEZONG', 'AWAOREG', 'ABRAND', 'AZEILPL', 'APLEZIER', 'AFIETS', 'AINBOED', 'ABYSTAND', 'CARAVAN')
datos = read.table('ticdata2000.txt', header = F, col.names = columnas)
datos$MOSTYPE <- factor(datos$MOSTYPE)
datos$MGEMLEEF <- factor(datos$MGEMLEEF)
datos$MOSHOOFD <- factor(datos$MOSHOOFD)
datos$MGODRK <- factor(datos$MGODRK)
datos$MGODPR <- factor(datos$MGODPR)
datos$MGODOV <- factor(datos$MGODOV)
datos$MGODGE <- factor(datos$MGODGE)
datos$MRELGE <- factor(datos$MRELGE)
datos$MRELSA <- factor(datos$MRELSA)
datos$MRELOV <- factor(datos$MRELOV)
datos$MFALLEEN <- factor(datos$MFALLEEN)
datos$MFGEKIND <- factor(datos$MFGEKIND)
datos$MFWEKIND <- factor(datos$MFWEKIND)
datos$MOPLHOOG <- factor(datos$MOPLHOOG)
datos$MOPLMIDD <- factor(datos$MOPLMIDD)
datos$MOPLLAAG <- factor(datos$MOPLLAAG)
datos$MBERHOOG <- factor(datos$MBERHOOG)
datos$MBERZELF <- factor(datos$MBERZELF)
datos$MBERBOER <- factor(datos$MBERBOER)
datos$MBERMIDD <- factor(datos$MBERMIDD)
datos$MBERARBG <- factor(datos$MBERARBG)
datos$MBERARBO <- factor(datos$MBERARBO)
datos$MSKA <- factor(datos$MSKA)
datos$MSKB1 <- factor(datos$MSKB1)
datos$MSKB2 <- factor(datos$MSKB2)
datos$MSKC <- factor(datos$MSKC)
datos$MSKD <- factor(datos$MSKD)
datos$MHHUUR <- factor(datos$MHHUUR)
datos$MHKOOP <- factor(datos$MHKOOP)
datos$MAUT1 <- factor(datos$MAUT1)
datos$MAUT2 <- factor(datos$MAUT2)
datos$MAUT0 <- factor(datos$MAUT0)
datos$MZFONDS <- factor(datos$MZFONDS)
datos$MZPART <- factor(datos$MZPART)
datos$MINKM30 <- factor(datos$MINKM30)
datos$MINK3045 <- factor(datos$MINK3045)
datos$MINK4575 <- factor(datos$MINK4575)
datos$MINK7512 <- factor(datos$MINK7512)
datos$MINK123M <- factor(datos$MINK123M)
datos$MINKGEM <- factor(datos$MINKGEM)
datos$MKOOPKLA <- factor(datos$MKOOPKLA)
datos$PWAPART <- factor(datos$PWAPART)
datos$PWABEDR <- factor(datos$PWABEDR)
datos$PWALAND <- factor(datos$PWALAND)
datos$PPERSAUT <- factor(datos$PPERSAUT)
datos$PBESAUT <- factor(datos$PBESAUT)
datos$PMOTSCO <- factor(datos$PMOTSCO)
datos$PVRAAUT <- factor(datos$PVRAAUT)
datos$PAANHANG <- factor(datos$PAANHANG)
datos$PTRACTOR <- factor(datos$PTRACTOR)
datos$PWERKT <- factor(datos$PWERKT)
datos$PBROM <- factor(datos$PBROM)
datos$PLEVEN <- factor(datos$PLEVEN)
datos$PPERSONG <- factor(datos$PPERSONG)
datos$PGEZONG <- factor(datos$PGEZONG)
datos$PWAOREG <- factor(datos$PWAOREG)
datos$PBRAND <- factor(datos$PBRAND)
datos$PZEILPL <- factor(datos$PZEILPL)
datos$PPLEZIER <- factor(datos$PPLEZIER)
datos$PFIETS <- factor(datos$PFIETS)
datos$PINBOED <- factor(datos$PINBOED)
datos$PBYSTAND <- factor(datos$PBYSTAND)
datos$CARAVAN <- factor(datos$CARAVAN)
library(caTools)
set.seed(123456)
splitted <- sample.split(datos, SplitRatio = 0.7)
datos.entrenamiento <- datos[splitted,]
datos.prueba <- datos[!splitted,]
summary(datos.entrenamiento)
```
Una parte importante de estos datos es describir la distribucion de la variable que se desea predecir, la cual es CARAVAN, a fin de conocer cuantos clientes poseen el seguro de caravanas, o no
```{r grafico seguros caravanas}
barplot(table(datos.prueba$CARAVAN), 
        main="Distribucion de compra de seguros",
        xlab = "Compro un seguro", 
        ylab="Cantidad")
```

Es posible ver que, para los datos de prueba, pocos clientes compraron el seguro de caravanas. Esto hace posible diferenciar que define un comprador de seguros. Es posible verificar la relacion entre los tipos de clientes, a fin de saber que tipo de cliente tiende a comprar el seguro de caravanas

``` {r grafico seguros y clientes que adquirieron seguro}
compraronSeguros = datos.entrenamiento[as.integer(datos.entrenamiento$CARAVAN) == 2,]
barplot(table(compraronSeguros$MOSTYPE),
        main = "Distribucion de tipos de clientes que compraron seguro",
        xlab = 'Tipo de cliente',
        ylab = 'cantidad de clientes')
```
Es sete observar que, de todos los client y es que compraron un seguro, la gran mayoria son familias de clase media, seguido por familias de clase baja, pero que son grandes (tipos 8 y 33 en el conjunto de datos) 

A fin de poder verificar si existen relaciones entre clientes y adquisicion del producto, es importante conocer la distribucion de los tipos de clientes del conjunto de datos:
``` {r grafico tipos de clientes}
barplot(table(datos.entrenamiento$MOSTYPE),
        main = "Distribucion de tipos de clientes en el conjunto de datos",
        xlab = 'Tipo de cliente',
        ylab = 'cantidad de clientes')
```

Se observa que la mayoria de clientes son familias largas de clae baja. Sin embargo, contastado con el grafico anterior, son pocos tipos de esta clientela que, en proporcion, adquieren un seguro. Esto quiere decir que para las personas que tienen pocos recursos, no les es posible adquirir el seguro que se solicita. 
A fin de completar el analisis, se procede a comparar las personas que, esta vez, no compraron seguuro, a fin de conocer la proporcion entre los tipos de cliente

``` {r grafico grafico seguros y clientes que NO adquirieron seguro}
noCompraronSeguros = datos.entrenamiento[as.integer(datos.entrenamiento$CARAVAN) == 1,]
barplot(table(noCompraronSeguros$MOSTYPE),
        main = "Distribucion de tipos de clientes que no compraron seguro",
        xlab = 'Tipo de cliente',
        ylab = 'cantidad de clientes')
```
Aqui es claro ver que la gran mayoria de los clientes que no compraron seguro fueron los de baja clase, lo que puede indicar que la clase es un factor determinante en caso de ser necesaria una prediccion.

## Modelo de Minería de Datos

Para estos datos, se practicaran tres modelos de mineria de datos, a fin de conocer cual es el mas exacto a la hora de realizar las predicciones. A continuacion se implementan dichos modelos:

### Arbol de decision
Se crea un arbol de decision a fin de poder predecir la variable que se desea, es decir, la variable de CARAVAN, utilizando todas las demas como argumentos:

``` {r Creacion arbol decision}
library(rpart)
library(rpart.plot)
modelo.arbol = rpart(CARAVAN ~ .,
                     data= datos.entrenamiento)
prp(modelo.arbol)
```
Es posible ver que, para este modelo particular, se indicara que, para todas las posibles entradas, el valor sera de cero, lo que quiere decir que ningun cliente comprara un seguro.

###Bosque aleatorio
Se procede a crear el modelo de árbol aleatorio. EL tamaño del bosque queda con sus valores predeterminados, de 500. 
```{r modelo-bosque-aleatorio}
library(randomForest)
modelo.bosque = randomForest(CARAVAN ~ .,
                     data= datos.entrenamiento)
```

A fin de verificar la creación del modelo, se procede a imprimir uno de los arboles creados en el bosque
```{r modelo-bosque-aleatorio-imrpimir}
getTree(modelo.bosque, 3)
```


## Evaluación

## Resultados